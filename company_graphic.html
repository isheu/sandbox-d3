<!-- Legend, Brush, Search, Tooltip, Annotations
defs, clippath 
Efficient Use of some sort of color brewer 
Find a company ... . real time searching...
Time series data, a workspace connection to previous. 
data exploration vs. an infographic
something along the lines of ipython notebook
-->
<html>
   <head>
      <script type="text/javascript" src="d3.v2.js"></script>
      <script type="text/javascript" src="jquery-1.10.2.js"></script>      
      <script type="text/javascript" src="jquery-ui-1.10.3\ui\jquery-ui.js"></script>
      <script type="text/javascript" src="company_graphic_tooltip.js"></script>
      <link rel="stylesheet" type="text/css" href="treemap_styles.css" />
      <link rel="stylesheet" type="text/css" href="jquery-ui-1.10.3.custom/css/smoothness/jquery-ui-1.10.3.custom.css" />
   </head>
   <body>
      <div id="main"></div>
      <div class="ui-widget">
         <label for="tags">Tags: </label>
         <input id="tags" />
      </div>
      <script type="text/javascript">
         var sectors = ["Industrials", "Health care", "Retailers", "Information technology", "Insurance", "Pharma", "Utilities", "Materials", "Consumer products", "Financials", "Energy", "Telecom"];
         var chart_height = 400;

         var cols_ttip_display = ["capital", "tax_rate", "sector"];
         var cols_ttip_display_name = {"capital":"Market Capitalization", "tax_rate":"Effective Tax Rate", "sector":"Sector"};

         var price_formatter = d3.format(">,");

         var svg_canvas = d3.select("body").append("svg:svg")
            .attr("id", "main_svg").attr("width", 1600).attr("height", 1600);

         var company_data_agg = [];
         d3.csv("data/placed_companies_all.csv", function(dataset) {   
            dataset.forEach(function(d) {
               company_data_agg.push({ "name": d.name, "capital": +d.capital, "tax_rate": +d.tax_rate, "sector": d.sector, 
                    "radius": +d.radius, "x":Math.floor(d.x), "y":Math.floor(d.y) })
            })
            svg_canvas.selectAll("circle.aggregate")
               .data(company_data_agg, function(d) { return d.name; })
               .enter().append("circle")
               .attr("class", "aggregate")
               .attr("fill", function(d) {
                     if (d.tax_rate <= 10) { return bubble_color_wheel[0].color }
                     else if ((d.tax_rate > 10) & (d.tax_rate <= 20)) { return bubble_color_wheel[1].color }
                     else if ((d.tax_rate > 20) & (d.tax_rate <= 30)) { return bubble_color_wheel[2].color }
                     else if ((d.tax_rate > 30) & (d.tax_rate <= 40)) { return bubble_color_wheel[3].color }
                     else if ((d.tax_rate > 40) & (d.tax_rate <= 50)) { return bubble_color_wheel[4].color }
                     else if (d.tax_rate > 50) { return bubble_color_wheel[5].color }
                  })
               .attr("id", function(d) { return d.name; })
               .attr("cx", function(d) { return d.x; })
               .attr("cy", function(d) { return d.y; })
               .attr("r", function(d) { return d.radius; });
            svg_canvas.append("svg:line")
               .attr("class", "x_line").attr("id", "x_line_agg")
               .attr("x1", 0)
               .attr("y1", function() { return chart_height / 2; })
               .attr("x2", 1600)
               .attr("y2", function() { return chart_height / 2; });
            
            d3.selectAll("circle.aggregate").on("mouseover", function(d) {
               gen_tooltip(d);
               d3.select(this).attr("stroke", "black");
            })
            d3.selectAll("circle.aggregate").on("mouseout", function() {
               d3.select(this).attr("stroke", "white");
               remove_tooltip()
            });
            var company_name_array = [];
            company_data_agg.forEach(function(d) { company_name_array.push(d.name) });
            $(function() { $( "#tags" ).autocomplete({ source: company_name_array }); })         
         })

         var company_data_split = [];
         d3.csv("data/placed_companies_by_sector.csv", function(dataset) {
            dataset.forEach(function(d) {
               company_data_split.push({ "name": d.name, "capital": d.capital, "tax_rate": +d.tax_rate, "sector": d.sector, 
                    "radius": +d.radius, "x":Math.floor(d.x), "y":Math.floor(d.y) })
            })
         })

         d3.select("body").append("div")
            .attr("id", "options")
            .style("top", 10)
            .style("left", 15)
            .style("position", "absolute");

         var toggle_to_data = company_data_split;
         var viz_state = 1; 
         var viz_state_to = 0;
         d3.select("div#options").append("button")
            .on("click", function() {
               svg_canvas.select("#x_line_agg")
                  .attr("opacity", viz_state).transition().duration(1200)
                  .attr("opacity", viz_state_to);
               d3.select("div.annotation")
                  .style("opacity", viz_state).transition().duration(1200)
                  .style("opacity", viz_state_to);                  
               svg_canvas.selectAll("circle.aggregate")
                  .data(toggle_to_data, function(d) { return d.name; })
                  .transition().duration(1200)
                  .delay(function(d) { return (d.tax_rate / 100) * 1200; })
                  .attr("cx", function(d) { return d.x; })
                  .attr("cy", function(d) { return d.y; })
               if (toggle_to_data == company_data_agg) { 
                     toggle_to_data = company_data_split
                     viz_state = 1
                     viz_state_to = 0; }
               else { 
                     toggle_to_data = company_data_agg 
                     viz_state = 0
                     viz_state_to = 1; }
            });
         gen_color_legend()
         gen_annotation()
      </script>
   </body>
</html>
